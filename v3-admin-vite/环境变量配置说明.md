# 环境变量配置说明

## 问题分析

你遇到的问题是：
1. **本机开发**：需要直接访问后端 `http://127.0.0.1:8080/da-ti-tong`
2. **生产部署**：需要通过 nginx 代理访问 `http://47.108.239.130/da-ti-tong`

## 解决方案

### 1. 创建环境变量文件

在 `v3-admin-vite` 目录下创建以下两个文件：

#### `.env.development` (开发环境)
```bash
# 开发环境配置
# 本机开发时，直接访问后端服务
VITE_BASE_API=http://127.0.0.1:8080/da-ti-tong

# 公共路径
VITE_PUBLIC_PATH=/
```

#### `.env.production` (生产环境)
```bash
# 生产环境配置
# 部署到服务器后，通过nginx代理访问
VITE_BASE_API=http://47.108.239.130/da-ti-tong

# 公共路径
VITE_PUBLIC_PATH=/
```

### 2. 已修复 vite.config.ts

已移除硬编码的 `VITE_BASE_API`，现在会从环境变量文件读取。

### 3. 重要注意事项

#### ⚠️ 协议问题
- **本机开发**：使用 `http://127.0.0.1:8080/da-ti-tong`（HTTP，不是 HTTPS）
- **生产环境**：使用 `http://47.108.239.130/da-ti-tong`（HTTP，因为通过 IP 访问）

**为什么不用 HTTPS？**
- 通过 IP 访问无法使用 HTTPS（需要域名和证书）
- 如果要用 HTTPS，需要配置域名并申请证书

#### ✅ 正确的配置

**开发环境（.env.development）：**
```
VITE_BASE_API=http://127.0.0.1:8080/da-ti-tong
```

**生产环境（.env.production）：**
```
VITE_BASE_API=http://47.108.239.130/da-ti-tong
```

### 4. 使用方法

#### 开发环境运行
```bash
npm run dev
# 或
pnpm dev
```
会自动读取 `.env.development` 文件

#### 生产环境构建
```bash
npm run build:prod
# 或
pnpm build:prod
```
会自动读取 `.env.production` 文件

### 5. 验证配置

构建后，检查 `v3-admin-vite/dist` 目录中的文件，搜索 `VITE_BASE_API` 的值，确认是否正确替换。

### 6. Nginx 配置检查

确保 nginx 配置正确：

```nginx
# HTTP 80 端口 - 后台管理（通过 IP 访问）
server {
    listen 80;
    server_name 47.108.239.130;

    root /www;
    index index.html index.htm;

    # 后台管理前端页面
    location / {
        try_files $uri $uri/ /index.html;
    }

    # 管理端 API 代理
    location /da-ti-tong/ {
        proxy_pass http://127.0.0.1:8080/da-ti-tong/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
```

### 7. 常见问题

#### Q: 为什么访问不了？
A: 检查以下几点：
1. ✅ 环境变量文件是否正确创建
2. ✅ `VITE_BASE_API` 是否使用 HTTP（不是 HTTPS）
3. ✅ nginx 是否正常运行：`systemctl status nginx`
4. ✅ nginx 配置是否正确：`nginx -t`
5. ✅ 后端服务是否运行：`curl http://127.0.0.1:8080/da-ti-tong/admin/api/project/question/list`
6. ✅ 防火墙是否开放 80 端口

#### Q: 本机开发时如何配置？
A: 使用 `.env.development` 文件，配置为：
```
VITE_BASE_API=http://127.0.0.1:8080/da-ti-tong
```

#### Q: 部署后如何配置？
A: 使用 `.env.production` 文件，配置为：
```
VITE_BASE_API=http://47.108.239.130/da-ti-tong
```

### 8. 测试步骤

1. **测试开发环境**：
   ```bash
   # 启动开发服务器
   npm run dev
   # 在浏览器访问 http://localhost:3333
   # 打开开发者工具，查看 Network 请求
   # 应该看到请求地址是 http://127.0.0.1:8080/da-ti-tong/...
   ```

2. **测试生产环境**：
   ```bash
   # 构建生产版本
   npm run build:prod
   # 上传到服务器 /www 目录
   # 访问 http://47.108.239.130
   # 打开开发者工具，查看 Network 请求
   # 应该看到请求地址是 http://47.108.239.130/da-ti-tong/...
   ```

3. **测试 API 代理**：
   ```bash
   # 在服务器上测试
   curl http://47.108.239.130/da-ti-tong/admin/api/project/question/list
   ```


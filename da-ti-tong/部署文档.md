# 答题通项目部署文档

## 一、环境准备

### 1.1 服务器要求
- 操作系统：CentOS 7+ / Ubuntu 18.04+ / 其他 Linux 发行版
- 内存：建议 4GB 以上
- 磁盘：建议 20GB 以上可用空间
- 网络：需要开放端口 80、443、3306、8080

### 1.2 安装 Docker

#### CentOS 系统安装 Docker

```bash
# 1. 卸载旧版本 Docker（如果已安装）
sudo yum remove -y docker \
                  docker-client \
                  docker-client-latest \
                  docker-common \
                  docker-latest \
                  docker-latest-logrotate \
                  docker-logrotate \
                  docker-engine

# 2. 安装必要的依赖包
sudo yum install -y yum-utils device-mapper-persistent-data lvm2

# 3. 添加 Docker 官方 yum 源（推荐使用阿里云镜像加速）
sudo yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo

# 4. 安装 Docker CE
sudo yum install -y docker-ce docker-ce-cli containerd.io

# 5. 启动 Docker 服务
sudo systemctl start docker

# 6. 设置 Docker 开机自启
sudo systemctl enable docker

# 7. 配置 Docker 镜像加速器（使用阿里云镜像）
sudo tee /etc/docker/daemon.json <<-'EOF'
{
  "registry-mirrors": ["https://e06lwqca.mirror.aliyuncs.com"]
}
EOF

# 8. 重新加载配置并重启 Docker
sudo systemctl daemon-reload
sudo systemctl restart docker

# 9. 验证 Docker 安装是否成功
docker --version
```

#### Ubuntu 系统安装 Docker

```bash
# 1. 更新 apt 包索引
sudo apt-get update

# 2. 安装必要的依赖包
sudo apt-get install -y \
    apt-transport-https \
    ca-certificates \
    curl \
    gnupg \
    lsb-release

# 3. 添加 Docker 官方 GPG 密钥
curl -fsSL https://mirrors.aliyun.com/docker-ce/linux/ubuntu/gpg | sudo gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg

# 4. 添加 Docker 仓库
echo \
  "deb [arch=amd64 signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://mirrors.aliyun.com/docker-ce/linux/ubuntu \
  $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null

# 5. 安装 Docker CE
sudo apt-get update
sudo apt-get install -y docker-ce docker-ce-cli containerd.io

# 6. 启动 Docker 服务
sudo systemctl start docker
sudo systemctl enable docker

# 7. 配置 Docker 镜像加速器
sudo tee /etc/docker/daemon.json <<-'EOF'
{
  "registry-mirrors": ["https://e06lwqca.mirror.aliyuncs.com"]
}
EOF

# 8. 重新加载配置并重启 Docker
sudo systemctl daemon-reload
sudo systemctl restart docker

# 9. 验证 Docker 安装是否成功
docker --version
```

### 1.3 安装 Docker Compose

```bash
# 方式一：使用 pip 安装（推荐）
# 1. 安装 pip（如果没有）
sudo yum install -y python3-pip
# 或者 Ubuntu 系统
# sudo apt-get install -y python3-pip

# 2. 安装 docker-compose
sudo pip3 install docker-compose

# 方式二：直接下载二进制文件（如果方式一失败）
sudo curl -L "https://github.com/docker/compose/releases/download/v2.20.0/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
sudo chmod +x /usr/local/bin/docker-compose

# 验证安装
docker-compose --version
```

## 二、项目准备

### 2.1 创建部署目录

```bash
# 在服务器上创建部署目录
sudo mkdir -p /service
cd /service
```

### 2.2 打包 Java 项目

在本地开发机器上执行：

```bash
# 进入项目根目录
cd da-ti-tong

# 使用 Maven 打包项目（跳过测试）
mvn clean package -DskipTests

# 打包完成后，在 target 目录下会生成 da-ti-tong-1.0.jar 文件
# 注意：确保 jar 包名称与 Dockerfile 中的名称一致
```

### 2.3 上传文件到服务器

将以下文件上传到服务器的 `/service` 目录：

1. **da-ti-tong-1.0.jar** - 打包好的 Java 应用 jar 包
2. **Dockerfile** - Docker 构建文件
3. **docker-compose.yml** - Docker Compose 配置文件
4. **default.conf** - Nginx 配置文件（可选，后续会重新配置）
5. **shua-ti-tong.sql** - 数据库初始化脚本

上传方式（任选一种）：

```bash
# 方式一：使用 scp 命令（在本地机器执行）
scp da-ti-tong-1.0.jar root@服务器IP:/service/
scp Dockerfile root@服务器IP:/service/
scp docker-compose.yml root@服务器IP:/service/
scp shua-ti-tong.sql root@服务器IP:/service/

# 方式二：使用 FTP 工具（如 FileZilla、WinSCP 等）
# 方式三：使用 Git 拉取代码到服务器
```

## 三、配置文件修改

### 3.1 修改 docker-compose.yml

编辑 `/service/docker-compose.yml` 文件，修改 MySQL 的用户名和密码：

```yaml
mysql:
  environment:
    TZ: "Asia/Shanghai"
    MYSQL_ROOT_PASSWORD: "你的root密码"  # 修改这里，例如：datitong2023*
    MYSQL_ALLOW_EMPTY_PASSWORD: "no"
    MYSQL_USER: '你的数据库用户名'        # 修改这里，例如：datitong
    MYSQL_PASSWORD: '你的数据库密码'    # 修改这里，例如：datitong2023*
```

**重要提示**：
- 请将 `你的root密码`、`你的数据库用户名`、`你的数据库密码` 替换为实际值
- 密码建议使用强密码（包含大小写字母、数字、特殊字符）
- 记住这些配置，后续需要在 application-dev.yml 中使用相同的配置

### 3.2 修改 application-dev.yml

编辑 `src/main/resources/application-dev.yml` 文件，修改以下配置：

#### 3.2.1 数据库配置

```yaml
spring:
  datasource:
    url: jdbc:mysql://mysql:3306/shua-ti-tong?useUnicode=true&characterEncoding=utf-8&useSSL=false
    username: 你的数据库用户名  # 必须与 docker-compose.yml 中的 MYSQL_USER 一致
    password: 你的数据库密码    # 必须与 docker-compose.yml 中的 MYSQL_PASSWORD 一致
```

#### 3.2.2 小程序配置

```yaml
wx_appid: 你的小程序AppID
wx_secret: 你的小程序AppSecret
```

#### 3.2.3 阿里云 OSS 配置

```yaml
aliyun:
  oss:
    endpoint: 你的OSS端点  # 例如：oss-cn-beijing.aliyuncs.com
    accessKeyId: 你的AccessKeyId
    accessKeySecret: 你的AccessKeySecret
    bucketName: datitong  # 你的OSS存储桶名称
    filedir: prod/doc/    # 文件存储目录
```

#### 3.2.4 阿里云短信配置

```yaml
aliyun:
  sms:
    accessKey: 你的短信AccessKey
    accessSecret: 你的短信AccessSecret
    tmpCode: 你的短信模板代码  # 例如：SMS_273755120
    signName: 你的短信签名     # 例如：康鑫的博客
```

#### 3.2.5 百度文字识别配置

```yaml
baidu:
  appId: 你的百度AppID
  appKey: 你的百度AppKey
  secretKey: 你的百度SecretKey
```

#### 3.2.6 微信支付配置

```yaml
wechat:
  pay:
    v3:
      miniapp:
        app-id: 你的小程序AppID
        app-secret: 你的小程序AppSecret
        app-v3-secret: 你的微信支付V3密钥
        mch-id: 你的商户号
        domain: 你的域名  # 例如：https://api.example.com
        cert-path: 你的证书路径  # 例如：/path/to/cert.pem
```

**配置完成后，重新打包项目**：

```bash
mvn clean package -DskipTests
```

**将新生成的 jar 包上传到服务器**：

```bash
scp target/da-ti-tong-1.0.jar root@服务器IP:/service/
```

## 四、创建挂载目录

在服务器上执行以下命令创建必要的目录：

```bash
# 进入部署目录
cd /service

# 创建 Nginx 挂载目录
sudo mkdir -p /service/nginx/html
sudo mkdir -p /service/nginx/conf.d
sudo touch /service/nginx/nginx.conf

# 创建 MySQL 挂载目录
sudo mkdir -p /service/mysql/conf.d
sudo mkdir -p /service/mysql/data
sudo mkdir -p /service/mysql/logs
```

## 五、初始化 Nginx 配置

```bash
# 1. 启动一个临时 Nginx 容器
docker run -d --name nginx-temp nginx

# 2. 从容器中复制配置文件到宿主机
docker cp nginx-temp:/etc/nginx/nginx.conf /service/nginx/nginx.conf
docker cp nginx-temp:/usr/share/nginx/html /service/nginx/html
docker cp nginx-temp:/etc/nginx/conf.d /service/nginx/conf.d

# 3. 删除临时容器
docker rm -f nginx-temp

# 4. 验证文件是否复制成功
ls -la /service/nginx/
```

## 六、配置 Nginx

### 6.1 编辑 Nginx 配置文件

```bash
# 进入 Nginx 配置目录
cd /service/nginx/conf.d

# 编辑或创建 default.conf 文件
vim default.conf
# 或者使用 nano 编辑器
# nano default.conf
```

### 6.2 配置内容

将以下配置内容复制到 `default.conf` 文件中，并根据实际情况修改：

```nginx
server {
    listen 443 ssl;
    server_name  你的域名;  # 修改为你的实际域名，例如：api.example.com
    
    # SSL 证书配置（如果有域名和证书）
    ssl_certificate /etc/nginx/conf.d/你的证书.pem;      # 修改为你的证书文件名
    ssl_certificate_key /etc/nginx/conf.d/你的证书.key;  # 修改为你的密钥文件名
    ssl_session_timeout 5m;
    ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:ECDHE:ECDH:AES:HIGH:!NULL:!aNULL:!MD5:!ADH:!RC4;
    ssl_protocols TLSv1.1 TLSv1.2 TLSv1.3;
    ssl_prefer_server_ciphers on;
    
    # 前端管理页面
    location / {
        root   /usr/share/nginx/html/;
        index  v3-admin-vite/index.html;
        try_files $uri $uri/ /v3-admin-vite/index.html;
    }

    # H5 页面
    location /h5 {
        alias /usr/share/nginx/html/h5;
        index index.html;
        try_files $uri $uri/ /h5/index.html;
    }

    # H5 静态资源
    location ^~ /assets/ {
        root   /usr/share/nginx/html/h5/assets/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    # 后端 API 代理
    location /da-ti-tong {
        proxy_pass http://da-ti-tong:8080;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}

# HTTP 重定向到 HTTPS（如果有 SSL 证书）
server {
    listen 80;
    server_name 你的域名;  # 修改为你的实际域名
    return 301 https://$server_name$request_uri;
}
```

### 6.3 上传 SSL 证书（如果有域名）

如果使用 HTTPS，需要将 SSL 证书上传到 `/service/nginx/conf.d/` 目录：

```bash
# 上传证书文件（在本地执行）
scp 你的证书.pem root@服务器IP:/service/nginx/conf.d/
scp 你的证书.key root@服务器IP:/service/nginx/conf.d/

# 设置证书文件权限
ssh root@服务器IP "chmod 600 /service/nginx/conf.d/你的证书.pem"
ssh root@服务器IP "chmod 600 /service/nginx/conf.d/你的证书.key"
```

**如果没有域名和证书，可以暂时使用 HTTP**：

```nginx
server {
    listen 80;
    server_name _;
    
    # 前端管理页面
    location / {
        root   /usr/share/nginx/html/;
        index  v3-admin-vite/index.html;
        try_files $uri $uri/ /v3-admin-vite/index.html;
    }

    # H5 页面
    location /h5 {
        alias /usr/share/nginx/html/h5;
        index index.html;
        try_files $uri $uri/ /h5/index.html;
    }

    # H5 静态资源
    location ^~ /assets/ {
        root   /usr/share/nginx/html/h5/assets/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    # 后端 API 代理
    location /da-ti-tong {
        proxy_pass http://da-ti-tong:8080;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
```

## 七、启动服务

### 7.1 检查文件

在启动前，确认以下文件都在 `/service` 目录下：

```bash
cd /service
ls -la

# 应该看到以下文件：
# - da-ti-tong-1.0.jar
# - Dockerfile
# - docker-compose.yml
# - shua-ti-tong.sql
```

### 7.2 启动 Docker Compose

```bash
# 进入部署目录
cd /service

# 启动所有服务（后台运行）
docker-compose up -d

# 查看服务状态
docker-compose ps

# 查看日志（如果启动失败，查看错误信息）
docker-compose logs
```

### 7.3 等待服务启动

```bash
# 查看 MySQL 容器日志，等待 MySQL 完全启动
docker-compose logs -f mysql

# 看到类似以下信息表示 MySQL 启动成功：
# [Note] [MY-010454] [Server] A temporary password is generated for root@localhost: ...
# [Note] [MY-010116] [Server] /usr/sbin/mysqld: ready for connections.

# 按 Ctrl+C 退出日志查看
```

## 八、初始化数据库

### 8.1 连接数据库

```bash
# 方式一：使用 Docker 命令连接（推荐）
docker exec -it mysql mysql -u你的数据库用户名 -p你的数据库密码

# 方式二：使用 MySQL 客户端工具（如 Navicat、DBeaver、MySQL Workbench）
# 连接信息：
# 主机：服务器IP
# 端口：3306
# 用户名：你在 docker-compose.yml 中配置的 MYSQL_USER
# 密码：你在 docker-compose.yml 中配置的 MYSQL_PASSWORD
```

### 8.2 创建数据库

```sql
-- 创建数据库
CREATE DATABASE IF NOT EXISTS `shua-ti-tong` DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

-- 使用数据库
USE `shua-ti-tong`;

-- 退出 MySQL
EXIT;
```

### 8.3 导入数据库脚本

```bash
# 方式一：使用 Docker 命令导入
docker exec -i mysql mysql -u你的数据库用户名 -p你的数据库密码 shua-ti-tong < /service/shua-ti-tong.sql

# 方式二：在 MySQL 客户端中执行
# 1. 连接数据库后，选择数据库：USE shua-ti-tong;
# 2. 执行 SQL 文件：source /service/shua-ti-tong.sql;
#    或者直接复制 shua-ti-tong.sql 文件内容到客户端执行
```

### 8.4 验证数据库导入

```bash
# 连接数据库
docker exec -it mysql mysql -u你的数据库用户名 -p你的数据库密码 shua-ti-tong

# 查看表
SHOW TABLES;

# 如果看到表列表，说明导入成功
# 退出
EXIT;
```

## 九、部署前端项目

### 9.1 上传前端文件

将前端项目打包后的文件上传到 `/service/nginx/html/` 目录：

```bash
# 方式一：使用 scp 上传
# 假设前端打包后的目录是 v3-admin-vite
scp -r v3-admin-vite root@服务器IP:/service/nginx/html/

# 方式二：上传压缩包后解压
scp v3-admin-vite.zip root@服务器IP:/service/nginx/html/
ssh root@服务器IP "cd /service/nginx/html && unzip v3-admin-vite.zip"

# H5 页面（如果有）
scp -r h5 root@服务器IP:/service/nginx/html/
```

### 9.2 修改前端配置

如果前端需要配置 API 地址，编辑前端项目的配置文件（通常在 `.env.production` 或 `config.js` 中）：

```javascript
// 将 baseUrl 修改为你的服务器地址
baseUrl: 'https://你的域名/da-ti-tong'
// 或者 HTTP
baseUrl: 'http://服务器IP/da-ti-tong'
```

重新打包前端项目并上传。

### 9.3 重启 Nginx

```bash
# 重启 Nginx 容器使配置生效
docker-compose restart nginx

# 或者重新加载配置（不中断服务）
docker exec nginx nginx -s reload
```

## 十、验证部署

### 10.1 检查容器状态

```bash
cd /service
docker-compose ps

# 应该看到三个容器都在运行：
# - da-ti-tong (后端服务)
# - nginx (Web 服务器)
# - mysql (数据库)
```

### 10.2 检查服务日志

```bash
# 查看后端服务日志
docker-compose logs da-ti-tong

# 查看 Nginx 日志
docker-compose logs nginx

# 查看 MySQL 日志
docker-compose logs mysql
```

### 10.3 测试访问

1. **测试后端 API**：
   ```bash
   # 在浏览器或使用 curl 测试
   curl http://服务器IP:8080/da-ti-tong/swagger-ui.html
   # 或者
   curl https://你的域名/da-ti-tong/swagger-ui.html
   ```

2. **测试前端页面**：
   - 在浏览器访问：`http://服务器IP` 或 `https://你的域名`
   - 应该能看到前端管理页面

3. **测试数据库连接**：
   ```bash
   # 查看后端日志，确认数据库连接成功
   docker-compose logs da-ti-tong | grep -i "mysql\|database\|datasource"
   ```

### 10.4 默认管理员账号

- **用户名**：`admin`
- **密码**：`admin`

**首次登录后请立即修改密码！**

## 十一、常用操作命令

### 11.1 服务管理

```bash
# 启动所有服务
cd /service
docker-compose up -d

# 停止所有服务
docker-compose down

# 重启所有服务
docker-compose restart

# 重启单个服务
docker-compose restart da-ti-tong
docker-compose restart nginx
docker-compose restart mysql

# 查看服务状态
docker-compose ps

# 查看服务日志
docker-compose logs -f da-ti-tong  # 实时查看后端日志
docker-compose logs -f nginx        # 实时查看 Nginx 日志
docker-compose logs -f mysql        # 实时查看 MySQL 日志
```

### 11.2 更新部署

```bash
# 1. 停止服务
cd /service
docker-compose down

# 2. 备份旧 jar 包（可选）
cp da-ti-tong-1.0.jar da-ti-tong-1.0.jar.bak

# 3. 上传新的 jar 包
# （在本地执行）scp target/da-ti-tong-1.0.jar root@服务器IP:/service/

# 4. 重新构建并启动
docker-compose up -d --build

# 5. 查看启动日志
docker-compose logs -f da-ti-tong
```

### 11.3 数据库备份

```bash
# 备份数据库
docker exec mysql mysqldump -u你的数据库用户名 -p你的数据库密码 shua-ti-tong > /service/backup_$(date +%Y%m%d_%H%M%S).sql

# 恢复数据库
docker exec -i mysql mysql -u你的数据库用户名 -p你的数据库密码 shua-ti-tong < /service/backup_20231201_120000.sql
```

## 十二、常见问题排查

### 12.1 容器无法启动

```bash
# 查看详细错误日志
docker-compose logs

# 检查端口是否被占用
netstat -tlnp | grep 8080
netstat -tlnp | grep 3306
netstat -tlnp | grep 80

# 如果端口被占用，修改 docker-compose.yml 中的端口映射
```

### 12.2 数据库连接失败

```bash
# 1. 检查 MySQL 容器是否正常运行
docker-compose ps mysql

# 2. 检查 MySQL 日志
docker-compose logs mysql

# 3. 测试数据库连接
docker exec -it mysql mysql -u你的数据库用户名 -p你的数据库密码

# 4. 检查 application-dev.yml 中的数据库配置是否正确
# 确保用户名、密码与 docker-compose.yml 中的配置一致
```

### 12.3 后端服务无法访问

```bash
# 1. 检查后端容器是否运行
docker-compose ps da-ti-tong

# 2. 查看后端日志
docker-compose logs da-ti-tong

# 3. 检查端口映射
docker-compose ps

# 4. 检查防火墙
# CentOS
sudo firewall-cmd --list-ports
sudo firewall-cmd --permanent --add-port=8080/tcp
sudo firewall-cmd --reload

# Ubuntu
sudo ufw status
sudo ufw allow 8080/tcp
```

### 12.4 Nginx 无法访问

```bash
# 1. 检查 Nginx 容器状态
docker-compose ps nginx

# 2. 查看 Nginx 日志
docker-compose logs nginx

# 3. 检查 Nginx 配置语法
docker exec nginx nginx -t

# 4. 检查端口和防火墙
netstat -tlnp | grep 80
netstat -tlnp | grep 443
```

### 12.5 前端页面 404

```bash
# 1. 检查前端文件是否存在
ls -la /service/nginx/html/

# 2. 检查 Nginx 配置中的路径是否正确
cat /service/nginx/conf.d/default.conf

# 3. 检查文件权限
sudo chown -R root:root /service/nginx/html/
sudo chmod -R 755 /service/nginx/html/
```

## 十三、防火墙配置

### CentOS 7+ 防火墙配置

```bash
# 查看防火墙状态
sudo systemctl status firewalld

# 开放必要端口
sudo firewall-cmd --permanent --add-port=80/tcp
sudo firewall-cmd --permanent --add-port=443/tcp
sudo firewall-cmd --permanent --add-port=3306/tcp
sudo firewall-cmd --permanent --add-port=8080/tcp

# 重新加载防火墙
sudo firewall-cmd --reload

# 查看开放的端口
sudo firewall-cmd --list-ports
```

### Ubuntu 防火墙配置

```bash
# 查看防火墙状态
sudo ufw status

# 开放必要端口
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp
sudo ufw allow 3306/tcp
sudo ufw allow 8080/tcp

# 启用防火墙（如果未启用）
sudo ufw enable
```

### 云服务器安全组配置

如果使用阿里云、腾讯云等云服务器，还需要在控制台配置安全组规则：

1. 登录云服务器控制台
2. 找到安全组配置
3. 添加入站规则：
   - 端口 80（HTTP）
   - 端口 443（HTTPS）
   - 端口 3306（MySQL，建议仅允许特定 IP）
   - 端口 8080（后端服务，建议仅允许内网访问）

## 十四、小程序配置

### 14.1 修改小程序配置

在小程序项目的 `config.js` 文件中，将 `baseUrl` 修改为你的服务器地址：

```javascript
// 开发环境
const baseUrl = 'https://你的域名/da-ti-tong';
// 或者
const baseUrl = 'http://服务器IP/da-ti-tong';

// 导出配置
module.exports = {
  baseUrl: baseUrl
};
```

### 14.2 小程序服务器域名配置

在微信公众平台配置服务器域名：

1. 登录 [微信公众平台](https://mp.weixin.qq.com/)
2. 进入「开发」->「开发管理」->「开发设置」
3. 配置「服务器域名」：
   - request 合法域名：`https://你的域名`
   - uploadFile 合法域名：`https://你的域名`
   - downloadFile 合法域名：`https://你的域名`

## 十五、完成部署检查清单

部署完成后，请确认以下项目：

- [ ] Docker 和 Docker Compose 已正确安装
- [ ] 所有配置文件已正确修改（docker-compose.yml、application-dev.yml）
- [ ] 所有必要的目录已创建
- [ ] Nginx 配置文件已正确设置
- [ ] 数据库已创建并导入数据
- [ ] 所有容器正常运行（docker-compose ps）
- [ ] 后端 API 可以访问（测试 Swagger 文档）
- [ ] 前端页面可以正常访问
- [ ] 数据库连接正常（查看后端日志）
- [ ] 防火墙和安全组已正确配置
- [ ] SSL 证书已配置（如果使用 HTTPS）
- [ ] 默认管理员密码已修改

## 十六、技术支持

如遇到问题，请按以下步骤排查：

1. 查看相关服务的日志：`docker-compose logs -f 服务名`
2. 检查配置文件是否正确
3. 确认网络和防火墙配置
4. 查看本文档的「常见问题排查」章节

---

**部署完成后，建议定期备份数据库和重要配置文件！**
